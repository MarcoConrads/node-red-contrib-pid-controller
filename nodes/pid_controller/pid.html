<script type="text/javascript">
    RED.nodes.registerType('pid-controller', {
        category: 'function',
        color: '#e6e0f8',
        defaults: {
            name:      { value: "" },

            // Basis PID-parameters (startwaarden)
            kp:        { value: 1.0,   required: true },
            Ti:        { value: 900.0, required: true },  // bijv. 15 min
            Td:        { value: 0.0,   required: true },

            outMin:    { value: 0.0,   required: true },
            outMax:    { value: 100.0, required: true },
            direction: { value: "direct" },

            // Zelflerend – geschikt voor trage temperatuurregeling
            autoTune:   { value: true },
            learnRateP: { value: 0.02 },
            learnRateI: { value: 0.02 },
            learnRateD: { value: 0.01 },

            kpMin:      { value: 0.01 },
            kpMax:      { value: 100.0 },

            TiMin:      { value: 10.0 },
            TiMax:      { value: 7200.0 },

            TdMin:      { value: 0.0 },
            TdMax:      { value: 600.0 }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-sliders",
        label: function () {
            return this.name || "pid-controller";
        }
    });
</script>

<!-- Editor template -->
<script type="text/x-red" data-template-name="pid-controller">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Naam</label>
        <input type="text" id="node-input-name" placeholder="bijv. Kamer PID">
    </div>

    <hr/>

    <div class="form-row">
        <label for="node-input-kp">Kp (start)</label>
        <input type="number" step="0.01" id="node-input-kp">
    </div>

    <div class="form-row">
        <label for="node-input-Ti">Ti (s, start)</label>
        <input type="number" step="1" id="node-input-Ti">
    </div>

    <div class="form-row">
        <label for="node-input-Td">Td (s, start)</label>
        <input type="number" step="1" id="node-input-Td">
    </div>

    <div class="form-row">
        <label for="node-input-outMin">Output min</label>
        <input type="number" step="0.1" id="node-input-outMin">
    </div>

    <div class="form-row">
        <label for="node-input-outMax">Output max</label>
        <input type="number" step="0.1" id="node-input-outMax">
    </div>

    <div class="form-row">
        <label for="node-input-direction">Richting</label>
        <select id="node-input-direction">
            <option value="direct">Direct (PV↑ → output↑)</option>
            <option value="reverse">Reverse (PV↑ → output↓)</option>
        </select>
    </div>

    <hr/>

    <div class="form-row">
        <label for="node-input-autoTune">Zelflerend</label>
        <input type="checkbox" id="node-input-autoTune" style="margin-top: 5px;">
        <span style="margin-left: 5px;">Auto-tune voor trage temperatuurregeling</span>
    </div>

    <div class="form-row">
        <label for="node-input-learnRateP">Learn rate Kp</label>
        <input type="number" step="0.01" id="node-input-learnRateP">
    </div>

    <div class="form-row">
        <label for="node-input-learnRateI">Learn rate Ti</label>
        <input type="number" step="0.01" id="node-input-learnRateI">
    </div>

    <div class="form-row">
        <label for="node-input-learnRateD">Learn rate Td</label>
        <input type="number" step="0.01" id="node-input-learnRateD">
    </div>

    <div class="form-row">
        <label for="node-input-kpMin">Kp min / max</label>
        <input type="number" step="0.01" id="node-input-kpMin" style="width: 45%;">
        <input type="number" step="0.01" id="node-input-kpMax" style="width: 45%; float: right;">
    </div>

    <div class="form-row">
        <label for="node-input-TiMin">Ti min / max (s)</label>
        <input type="number" step="1" id="node-input-TiMin" style="width: 45%;">
        <input type="number" step="1" id="node-input-TiMax" style="width: 45%; float: right;">
    </div>

    <div class="form-row">
        <label for="node-input-TdMin">Td min / max (s)</label>
        <input type="number" step="1" id="node-input-TdMin" style="width: 45%;">
        <input type="number" step="1" id="node-input-TdMax" style="width: 45%; float: right;">
    </div>

</script>

<!-- Help-tekst in de editor -->
<script type="text/x-red" data-help-name="pid-controller">
    <p>
        PID-regelaar voor Node-RED, ontworpen voor <b>trage temperatuurregelingen</b>
        (bijv. kamer, vloerverwarming, boiler).
    </p>

    <p>
        <b>Input:</b><br/>
        - <code>msg.payload</code>: proceswaarde (PV), bijv. gemeten temperatuur<br/>
        - <code>msg.setpoint</code>: setpoint (SP), bijv. gewenste temperatuur<br/>
        - <code>msg.reset</code> (optioneel):<br/>
        &nbsp;&nbsp;• <code>true</code> of <code>"hard"</code> reset: reset intern geheugen én vergeet opgeslagen PID-parameters
    </p>

    <p>
        <b>Output:</b><br/>
        - <code>msg.payload</code>: regeloutput (CV), geschaald tussen <code>outMin</code> en <code>outMax</code><br/>
        - <code>msg.pid</code>: extra info (PV, SP, fout, P/I/D-termen, Kp, Ti, Td, Ki, Kd, dt)
    </p>

    <h4>Zelflerende modus</h4>
    <p>
        Als <b>Zelflerend</b> is aangevinkt, bewaakt de node over een lange periode
        (typisch ~20 minuten) de fout en oscillerend gedrag, en past dan
        <code>Kp</code> en <code>Ti</code> in kleine stapjes aan:
    </p>
    <ul>
        <li>Grote fout, weinig oscillatie → Kp iets omhoog, Ti iets korter</li>
        <li>Veel oscillatie → Kp iets omlaag, Ti iets langer</li>
        <li>Blijvende offset → Ti iets korter</li>
    </ul>

    <p>
        De actuele waarden van Kp/Ti/Td worden opgeslagen in de Node-RED context
        (via <code>node.context()</code>) zodat na een herstart wordt
        verdergegaan met de laatste getunede waarden.<br/>
        Zorg dat in <code>settings.js</code> <b>contextStorage</b> is
        ingesteld met een <code>localfilesystem</code>-store als je dit
        persistent op schijf wilt bewaren.
    </p>

    <h4>Tip voor gebruik</h4>
    <ul>
        <li>Gebruik een sample-interval van ca. 10–30 seconden.</li>
        <li>Begin met conservatieve waarden (lage Kp, grote Ti) en laat de zelflerende modus uren draaien.</li>
        <li>Monitor <code>msg.pid</code> met een debug node of dashboard grafiek.</li>
    </ul>
</script>
