<script type="text/javascript">
    RED.nodes.registerType('pid-controller', {
        category: 'function',
        color: '#e6e0f8',
        defaults: {
            name:      { value: "" },

            // Basic PID parameters (initial values)
            kp:        { value: 1.0,   required: true },
            Ti:        { value: 0.0, required: true },  // e.g. 15 min
            Td:        { value: 0.0,   required: true },

            outMin:    { value: 0.0,   required: true },
            outMax:    { value: 100.0, required: true },
            direction: { value: "direct" },

            // Self-learning – suitable for slow temperature control
            autoTune:   { value: true },
            learnRateP: { value: 0.02 },
            learnRateI: { value: 0.02 },
            learnRateD: { value: 0.01 },

            kpMin:      { value: 0.01 },
            kpMax:      { value: 100.0 },

            TiMin:      { value: 10.0 },
            TiMax:      { value: 7200.0 },

            TdMin:      { value: 0.0 },
            TdMax:      { value: 600.0 }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-sliders",
        label: function () {
            return this.name || "pid-controller";
        }
    });
</script>

<!-- Editor template -->
<script type="text/x-red" data-template-name="pid-controller">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="e.g. Room PID">
    </div>

    <hr/>

    <div class="form-row">
        <label for="node-input-kp">Kp (initial)</label>
        <input type="number" step="0.01" id="node-input-kp">
    </div>

    <div class="form-row">
        <label for="node-input-Ti">Ti (s, initial)</label>
        <input type="number" step="1" id="node-input-Ti">
    </div>

    <div class="form-row">
        <label for="node-input-Td">Td (s, initial)</label>
        <input type="number" step="1" id="node-input-Td">
    </div>

    <div class="form-row">
        <label for="node-input-outMin">Output min</label>
        <input type="number" step="0.1" id="node-input-outMin">
    </div>

    <div class="form-row">
        <label for="node-input-outMax">Output max</label>
        <input type="number" step="0.1" id="node-input-outMax">
    </div>

    <div class="form-row">
        <label for="node-input-direction">Direction</label>
        <select id="node-input-direction">
            <option value="direct">Direct (PV↑ → output↑)</option>
            <option value="reverse">Reverse (PV↑ → output↓)</option>
        </select>
    </div>

    <hr/>

    <div class="form-row">
        <label for="node-input-autoTune">Self-learning</label>
        <input type="checkbox" id="node-input-autoTune" style="margin-top: 5px;">
        <span style="margin-left: 5px;">Auto-tuning for slow temperature control</span>
    </div>

    <div class="form-row">
        <label for="node-input-learnRateP">Learn rate Kp</label>
        <input type="number" step="0.01" id="node-input-learnRateP">
    </div>

    <div class="form-row">
        <label for="node-input-learnRateI">Learn rate Ti</label>
        <input type="number" step="0.01" id="node-input-learnRateI">
    </div>

    <div class="form-row">
        <label for="node-input-learnRateD">Learn rate Td</label>
        <input type="number" step="0.01" id="node-input-learnRateD">
    </div>

    <div class="form-row">
        <label for="node-input-kpMin">Kp min / max</label>
        <input type="number" step="0.01" id="node-input-kpMin" style="width: 35%;">
        <input type="number" step="0.01" id="node-input-kpMax" style="width: 35%; float: right;">
    </div>

    <div class="form-row">
        <label for="node-input-TiMin">Ti min / max (s)</label>
        <input type="number" step="1" id="node-input-TiMin" style="width: 35%;">
        <input type="number" step="1" id="node-input-TiMax" style="width: 35%; float: right;">
    </div>

    <div class="form-row">
        <label for="node-input-TdMin">Td min / max (s)</label>
        <input type="number" step="1" id="node-input-TdMin" style="width: 35%;">
        <input type="number" step="1" id="node-input-TdMax" style="width: 35%; float: right;">
    </div>

</script>

<!-- Help text in the editor -->
<script type="text/x-red" data-help-name="pid-controller">
    <p>
        PID controller for Node-RED, designed for <b>slow temperature control</b>
        (e.g. room heating, underfloor heating, boiler).
    </p>

    <p>
        <b>Input:</b><br/>
        - <code>msg.payload</code>: process value (PV), e.g. measured temperature<br/>
        - <code>msg.setpoint</code>: setpoint (SP), e.g. desired temperature<br/>
        - <code>msg.reset</code> (optional):<br/>
        &nbsp;&nbsp;• <code>true</code> or <code>"hard"</code> reset: resets internal memory and forgets stored PID parameters
    </p>

    <p>
        <b>Output:</b><br/>
        - <code>msg.payload</code>: control output (CV), scaled between <code>outMin</code> and <code>outMax</code><br/>
        - <code>msg.pid</code>: additional info (PV, SP, error, P/I/D terms, Kp, Ti, Td, Ki, Kd, dt)
    </p>

    <h4>Self-learning mode</h4>
    <p>
        When <b>Self-learning</b> is enabled, the node monitors the error and
        oscillatory behavior over a long period
        (typically ~20 minutes) and then adjusts
        <code>Kp</code> and <code>Ti</code> in small steps:
    </p>
    <ul>
        <li>Large error, little oscillation → slightly increase Kp, shorten Ti</li>
        <li>Strong oscillation → slightly decrease Kp, lengthen Ti</li>
        <li>Persistent offset → shorten Ti</li>
    </ul>

    <p>
        The current values of Kp/Ti/Td are stored in the Node-RED context
        (via <code>node.context()</code>) so that after a restart
        the controller continues with the last tuned values.<br/>
        Make sure <b>contextStorage</b> is configured in <code>settings.js</code>
        with a <code>localfilesystem</code> store if you want this
        to be persisted to disk.
    </p>

    <h4>Usage tips</h4>
    <ul>
        <li>Use a sample interval of approximately 10–30 seconds.</li>
        <li>Start with conservative values (low Kp, large Ti) and let the self-learning mode run for several hours.</li>
        <li>Monitor <code>msg.pid</code> using a debug node or a dashboard chart.</li>
    </ul>
</script>
